#!/usr/bin/bash
# cpugov - see https://github.com/mwyvr/dotfiles
usage() {
	cat <<EOF
Usage:
    cpugov [powersave|performance|schedutil] - sets governor
    cpugov list     - display current CPU scheduling governor
    cpugov watch    - monitors current CPU frequencies

EOF
}

DOAS=""

checkroot() {
	if command -v sudo &>/dev/null; then
		DOAS=$(which sudo)
	elif command -v doas &>/dev/null; then
		DOAS=$(which doas)
	fi
	if [ -z "$DOAS" ]; then
		echo "cpugov: No sudo or doas available"
	fi
}

if [ -z "$1" ]; then
	usage
	exit
fi

if ! compgen -G "/sys/devices/system/cpu/cpu*/cpufreq/scaling_governor" >/dev/null; then
	echo "cpugov: scaling_governor not present in devices/system/cpu/... is this a VM?"
	exit
fi

change() {
	checkroot
	echo $1 | $DOAS tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
}

case $1 in
list)
	cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
	exit
	;;
watch)
	watch -n 1 cat /sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_cur_freq
	exit
	;;
powersave)
	change
	;;
schedutil)
	change
	;;
performance)
	change
	;;
*)
	echo "Error: Invalid mode: [$1]"
	usage
	exit
	;;
esac
