#!/bin/sh
# Winbox is a Mikrotik router management tool; v4 provides Linux compatibility
# but they don't offer a musl libc compatible version. Fortunately v4 is fully
# functional as a Wine-run application.
#
# See also ~/.local/share/applications/winbox.desktop which calls this.

. /etc/os-release
export EXEPATH="$HOME/.local/bin"
export EXE="WinBox.exe"
export ZIPFILE="WinBox_Windows.zip"
FETCHER=wget

setup() {
    # download if not already done
    if [ ! -f "$EXEPATH/$EXE" ]; then
        $FETCHER -o "$EXEPATH/$ZIPFILE" https://download.mikrotik.com/routeros/winbox/4.0beta9/WinBox_Windows.zip
        cd $EXEPATH
        unzip $ZIPFILE
    fi
    if ! command -v "$(which wine64)"; then
        # Some Linux distributions install an absurd volume of packages for Wine,
        # - looking at you, openSUSE - on those run we always want Wine via a distrobox.
        echo "Install wine; on openSUSE install within and export wine64 from a distrobox"
        exit 1
    fi
}

distrorun() {
    # depends on an already configured distrobox named "chimera"
    if [ -z "${CONTAINER_ID}" ]; then
        "/usr/bin/distrobox-enter" -n chimera -- '/usr/bin/wine64' "$EXEPATH/$EXE"
    elif [ -n "${CONTAINER_ID}" ] && [ "${CONTAINER_ID}" != "chimera" ]; then
        exec distrobox-host-exec '/home/$USER/.local/bin/wine64' "$EXEPATH/$EXE"
    else
        exec '/usr/bin/wine64' "$EXEPATH/$EXE"
    fi
    distrobox-stop -Y chimera
}

run() {
    cd $EXEPATH
    /usr/bin/wine64 "$EXEPATH/$EXE"
}

case $ID in
chimera)
    FETCHER=fetch
    setup
    run
    ;;
void)
    setup
    run
    ;;
aeon)
    setup
    distrorun
    ;;
*)
    setup
    distrorun
    ;;
esac
