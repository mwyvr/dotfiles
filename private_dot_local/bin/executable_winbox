#!/bin/sh
# Winbox is a Mikrotik router management tool; v4 will provide Linux compatibility
# but for the time being, running v3.x which is a Windows executable. Update to 4.0x,
# which offers native Linux support, when out of beta.
#
# See also ~/.local/share/applications/winbox.desktop which calls this.

. /etc/os-release
export EXEPATH="$HOME/.local/bin"
export EXE="WinBox.exe"
export ZIPFILE="WinBox_Windows.zip"

setup() {
    # download if not already done
    if [ ! -f "$EXE" ]; then
        $FETCHER -o "$EXEPATH/$ZIPFILE" https://download.mikrotik.com/routeros/winbox/4.0beta9/WinBox_Windows.zip
        cd $EXEPATH
        unzip $ZIPFILE
    fi
    if ! command -v "$(which wine64)"; then
        # Some Linux distributions install an absurd volume of packages for Wine,
        # - looking at you, openSUSE - on those run Wine via a distrobox.
        echo "Install wine; on openSUSE install within and export wine64 from a distrobox"
        exit 1
    fi
}

distrorun() {
    # depends on an already configured distrobox named "archbox"
    if [ -z "${CONTAINER_ID}" ]; then
        "/usr/bin/distrobox-enter" -n archbox -- '/usr/bin/wine64' "$EXE"
    elif [ -n "${CONTAINER_ID}" ] && [ "${CONTAINER_ID}" != "tumbleweed" ]; then
        exec distrobox-host-exec '/home/mw/.local/bin/wine64' "$EXE"
    else
        exec '/usr/bin/wine64' "$EXE"
    fi
    distrobox-stop -Y tumbleweed
}

run() {
    cd $EXEPATH
    /usr/bin/wine64 "$EXE"
}

case $ID in
chimera)
    FETCHER=fetch
    setup
    run
    ;;
void)
    FETCHER=fetch
    setup
    run
    ;;
*)
    # probably openSUSE TW or Aeon
    FETCHER=wget
    setup
    distrorun
    ;;
esac
