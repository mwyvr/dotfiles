#!/bin/sh
# package update/upgrade & fw updates for FreeBSD and various Linux
# distributions (Chimera Linux, Void Linux, openSUSE Tumbleweed and Aeon
# Desktop)
. ~/.local/bin/functions.sh

do_fw() {
  # Only installed on my laptops; see https://fwupd.org
  if type fwupdmgr >/dev/null 2>&1; then
    echo "Checking firmware"
    fwupdmgr get-updates && fwupdmgr update
  fi
}

echo "Checking $ID packages"
case $ID in
darwin)
  $DOAS port selfupdate
  $DOAS port upgrade outdated
  exit
  ;;
chimera)
  $DOAS apk update
  $DOAS apk upgrade
  do_fw
  ;;
freebsd)
  $DOAS pkg update
  $DOAS pkg upgrade
  ;;
opensuse-tumbleweed)
  $DOAS zypper dup
  do_fw
  ;;
aeon)
  $DOAS transactional-update dup
  # fw updates built in
  ;;
opensuse-microos)
  # server os
  $DOAS transactional-update dup
  ;;
void)
  $DOAS xbps-install -Su
  do_fw
  ;;
*)
  echo "Unknown operating system, terminating."
  exit 1
  ;;
esac

if type flatpak >/dev/null 2>&1; then
  echo "Checking flatpak"
  $DOAS flatpak update -y
fi

if [ -n "$DBUS_SESSION_BUS_ADDRESS" ]; then
  if type notify-send >/dev/null 2>&1; then
    notify-send --transient --app-name="Update" --urgency=normal "update" "System update script has completed"
  fi
  # force update of the status bar
  if pgrep waybar >/dev/null 2>&1; then
    pkill -SIGRTMIN+8 waybar
  fi
fi
