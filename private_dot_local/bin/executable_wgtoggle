#!/bin/sh
# wgtoggle activates or deactivates the wireguard connection
# - wireguard.desktop calls this
# - updates waybar status if running
# wg0 must be defined.

. ~/.local/bin/functions.sh

IF=wg0

case $ID in
darwin)
  # Create an automator.app entry for wgtoggle to make it easy to launch from Spotlight
  # Notifications require enabling "Script Editor" within System Settings -> Notifications
  if networksetup -showpppoestatus $IF | grep -q "^disconnected"; then
    echo "connecting"
    networksetup -connectpppoeservice $IF
    osascript -e 'display notification "Wireguard connected" with title "Wireguard"'
  else
    echo "disconnecting"
    networksetup -disconnectpppoeservice $IF
    osascript -e 'display notification "Wireguard disconnected" with title "Wireguard"'
  fi
  exit
  ;;
*)
  if nmcli connection show --active | grep -qF $IF; then
    nmcli connection down $IF >/dev/null 2>&1
    MSG="interface down"
  else
    # knockknock.sh
    nmcli connection up $IF >/dev/null 2>&1
    MSG="interface up"
  fi
  if [ -n "$DBUS_SESSION_BUS_ADDRESS" ]; then
    notify-send --transient --app-name=wgtoggle --urgency=normal "wireguard" "$IF $MSG"
    if pgrep waybar >/dev/null 2>&1; then
      ip add show | grep -qF $IF && echo "󰦝" || echo "󱦛"
      pkill -SIGRTMIN+9 waybar
    fi
  fi
  ;;
esac
