#!/usr/bin/bash
# dropips is meant to be run via snooze (or cron) and scans logfiles for the
# following:
#
#     - failed mail server authentication attempts
#     - hosts attempting connection with or only offering insecure protocols
#     - spf policy rejects; on this server these are 100% spam or scams
#
# ... and adds a DROP rule to iptables.
#
# In addition the script adds some hard coded IP addresses or address blocks
# for prolific spammers and crackers.
#
# The script attempts to insert an ACCEPT rule for your IP address to avoid
# locking out an admin, if run from the command line.
#
# By default dropips parses only /var/log/socklog/messages/current; to
# catch up with prior activity, supply any argument to the script.

# IMPORTANT: When making changes, don't forget to install it to cron.hourly once tested.
# To install to cron.hourly run:
#   dropips install

SCRIPT=$(test -L "$0" && readlink "$0" || echo "$0")
BASE=$(basename "$SCRIPT")
SCOPE="/var/log/socklog/messages/current"

if [ "$(id -u)" -ne 0 ]; then
	echo "$SCRIPT must be run as root."
	exit
fi

install_to_cron() {
	# ensure the latest is installed in hourly
	# Note: Void/runit run-parts command won't launch a script ending in .sh
	cp $SCRIPT /etc/cron.hourly/$BASE
	chmod +x /etc/cron.hourly/$BASE
	logger "$BASE installed itself to /etc/cron.hourly/"
}

# command line argument are optional:
# - if "install", install script to cron.hourly for run-parts/snooze to process
# - if "all", reset, drop any countries defined, and process all the log files current and past
if [ ! $# -eq 0 ]; then
	if [ "$1" == "install" ]; then
		install_to_cron
		echo "Installed, exiting"
		exit
	elif [ "$1" == "all" ]; then
		echo "Scanning all logs"
		SCOPE="/var/log/socklog/messages/*"
	elif [ "$1" == "reset" ]; then
		echo "Resetting iptables"
		iptables -F
		COUNTRIES="cn ru"
		echo "Dropping countries: $COUNTRIES. Please wait."
		BASE_URL="https://www.ipdeny.com/ipblocks/data/aggregated/"
		URL_SUFFIX="-aggregated.zone"
		for code in $COUNTRIES; do
			echo "Dropping $code"
			URL="$BASE_URL$code$URL_SUFFIX"
			echo $URL
			for ip in $(curl $URL); do
				iptables -A INPUT -j DROP -s $ip
			done
		done
		echo "Setting scope to all logs and processing."
		SCOPE="/var/log/socklog/messages/*"
	else
		echo "$SCRIPT: Bad command: $1. Use install, all, or reset"
		logger "$SCRIPT: Bad command: $1. Use install, all, or reset"
		exit
	fi
fi

# new blocks derived from logs
COUNT=0
logger "$SCRIPT starting"

# assumes only sysadmin(s) or other authorized users have ssh access
DONTBLOCK=$(ss | grep ssh | grep ESTAB | awk '{print $6}' | cut -d ":" -f 1 | sort | uniq)
# script to return my office ip, not in git
OFFICEIP=$(/etc/dontblockme)
DONTBLOCK="$DONTBLOCK $OFFICEIP"
for ip in $DONTBLOCK; do
	# if not in table, INSERT a rule to protect us
	if ! iptables -C INPUT -j ACCEPT -s "$ip" >/dev/null 2>&1; then
		iptables -I INPUT -s "$ip" -j ACCEPT
		logger "ACCEPT rule added for $ip"
	else
		logger "ACCEPT rule exists for $ip"
	fi
done

# all other rules are APPENDED
# mail system, failed auth
for ip in $(cat $SCOPE | grep "mox.*failed auth" | awk -F 'remote=| cid' '{print $2}' | sort | uniq); do
	case "$ip" in
	$DONTBLOCK)
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		# Unless iptables has been flushed recently, this will always be false
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox failed auth DROP $ip"
			let COUNT++
		fi
		;;
	esac
done

# mail system, spf violators - all are attacks on our domains or spoofs of legit biz
for ip in $(cat $SCOPE | grep "mox.*spf fail.*your ip" | awk -F 'your ip | is not' '{print $2}' | sort | uniq); do
	case "$ip" in
	$DONTBLOCK)
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		# Unless iptables has been flushed recently, this will always be false
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox spf fail DROP $ip"
			let COUNT++
		fi
		;;
	esac
done

# mail system, dnsbl rejects, often for malware
for ip in $(cat $SCOPE | grep "mox.*rejecting due to listing in dnsbl.*Listed by CSS" | awk -F'/ip/|\" mailfrom' '{print $2}' | sort | uniq); do
	case "$ip" in
	$DONTBLOCK)
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		# Unless iptables has been flushed recently, this will always be false
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox dnsbl reject DROP $ip"
			let COUNT++
		fi
		;;
	esac
done

# IMPORTANT: When making changes, don't forget to install it to cron.hourly once tested.
# To install to cron.hourly run:
#   dropips install

# static list of noted bad actors
BADACTORS=(
	# prolific spammers
	"194.169.175.0/24" # gb emanuelhosting
	"102.210.41.0/24"  # ke bitcoin porn scam
	"176.88.185.0/24"  # tr bitcoin porn scam
	"179.152.0.0/14"   # br porn bitcoin scam
	"186.33.88.128/25" # do bitcoin porn scam
	"190.42.0.0/17"    # pe bitcoin porn scam
	"196.176.0.0/14"   # tn bitcoin porn scam
	"41.211.128.0/19"  # ga porn bitcoin scam
	"178.162.128.0/18" # nl leaseweb
	"185.49.69.0/24"   # gb leaseweb
	"37.48.64.0/18"    # nl leaseweb
	"5.79.64.0/18"     # nl leaseweb
	"81.171.0.0/19"    # nl leaseweb
	"62.210.0.0/16"    # fr Scaleway hosts malware, dns blocklisted
	"62.4.0.0/19"      # fr scaleway
	"163.172.0.0/16"   # fr Scaleway hosts malware, dns blocklisted
	"200.75.0.0/19"    # cl spam hosts
	"192.119.160.0/20" # us "madgenius.com" scam sender
	"155.94.191.0/24"  # us "madgenius.com" scam sender
	"165.140.240.0/22" # us alphavps scam sender
	"109.71.254.0/24"  # de emeraldhost.de apple ID phishing scammer
	"41.61.0.0/17"     # hu grindhost - canadapost/intelcom phishing scammer; viagra
	"77.87.208.0/21"   # ru bad spam, now covered by country block
	"5.104.104.0/21"   # de male gummies
	# notable smtp connections without purpose or no tls (always bad actors)
	"193.222.96.0/24" # fr contantmoulin, 4000 connections over several days
	"80.76.49.0/24"   # fr
	"43.158.217.0/24" # sg
	# auth violators
	"111.0.0.0/10"   # cn - china mobile
	"27.115.0.0/17"  # cn - china unicom
	"80.244.11.0/24" # ir - iran posing as nl
	# spf and dmarc violators
	"191.180.0.0/14"  # br
	"103.31.179.0/24" # bd
	"149.54.32.0/24"  # zz afghanistan
	# # msedge.exe / exploit
	"212.102.40.0/23" # uk /dallas us
	# many connections for no purpose
)

for ip in "${BADACTORS[@]}"; do
	case $ip in
	$DONTBLOCK)
		iptables -C INPUT -j ACCEPT -s "$ip" >/dev/null 2>&1 || iptables -I INPUT -s "$ip" -j ACCEPT
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox known bad actors DROP $ip"
			let COUNT++
		fi
		;;
	esac
done

logger "$SCRIPT finished, $COUNT DROP rules added"
