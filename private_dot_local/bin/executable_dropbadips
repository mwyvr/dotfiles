#!/usr/bin/bash
# dropips is meant to be run via snooze (or cron) and scans logfiles for the
# following:
#
#     - failed mail server authentication attempts
#     - hosts attempting connection with or only offering insecure protocols
#
# ... and adds a DROP rule to iptables.
#
# In addition the script adds some hard coded IP addresses or address blocks
# for prolific spammers and crackers.
#
# The script attempts to insert an ACCEPT rule for your IP address to avoid
# locking out an admin, if run from the command line.
#
# By default dropips parses only /var/log/socklog/messages/current; to
# catch up with prior activity, supply any argument to the script.
#
# To install to cron.hourly run:
#   dropips install

SCRIPT=$(test -L "$0" && readlink "$0" || echo "$0")
BASE=$(basename "$SCRIPT")
SCOPE="/var/log/socklog/messages/current"

if [ "$(id -u)" -ne 0 ]; then
	echo "$SCRIPT must be run as root."
	exit
fi

install_to_cron() {
	# ensure the latest is installed in hourly
	# Note: Void/runit run-parts command won't launch a script ending in .sh
	cp $SCRIPT /etc/cron.hourly/$BASE
	chmod +x /etc/cron.hourly/$BASE
	logger "$BASE installed itself to /etc/cron.hourly/"
}

# command line argument are optional:
# - if "install", install script to cron.hourly for run-parts/snooze to process
# - any other arg, process all the log files current and past
if [ ! $# -eq 0 ]; then
	if [ "$1" == "install" ]; then
		install_to_cron
		echo "Installed, exiting"
		exit
	else
		SCOPE="/var/log/socklog/messages/*"
	fi
fi

# new blocks
COUNT=0

# don't block us/assumes only the sysadmin(s) or other authorized users have ssh access
DONTBLOCK=$(ss | grep ssh | grep ESTAB | awk '{print $6}' | cut -d ":" -f 1 | sort | uniq)

logger "$SCRIPT starting"

# mail system
for ip in $(cat $SCOPE | grep "mox.*failed auth" | awk -F 'remote=| cid' '{print $2}' | sort | uniq); do
	case "$ip" in
	$DONTBLOCK)
		iptables -C INPUT -j ACCEPT -s "$ip" >/dev/null 2>&1 || iptables -I INPUT -s "$ip" -j ACCEPT
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		# Unless iptables has been flushed recently, this will always be false
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox failed auth DROP $ip"
			let COUNT++
		fi
		;;
	esac
done

# http server; some are legit internet intel scans but who cares
for ip in $(cat $SCOPE | grep "TLS handshake error.*unsupported" | awk '{ sub(/.* handshake error from /,""); sub(/:.*/,""); print }' | sort | uniq); do
	case $ip in
	$DONTBLOCK)
		iptables -C INPUT -j ACCEPT -s "$ip" >/dev/null 2>&1 || iptables -I INPUT -s "$ip" -j ACCEPT
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox unsupported HTTP TLS DROP $ip"
			let COUNT++
		fi
		;;
	esac
done

BADACTORS=(
	# prolific spammers
	"194.169.175.0/24" # gb
	"194.169.175.4"    # gb
	"194.169.175.0/24" # gb
	"41.211.128.0/19"  # ga porn bitcoin scam
	"179.152.0.0/14"   # br porn bitcoin scam
	"196.176.0.0/14"   # tn bitcoin porn scam
	"190.42.0.0/17"    # pe bitcoin porn scam
	"102.210.41.0/24"  # ke bitcoin porn scam
	"176.88.185.0/24"  # tr bitcoin porn scam
	"185.49.69.0/24"   # gb - leaseweb
	"5.79.64.0/18"     # NL - Leaseweb
	"178.162.128.0/18" # NL - Leaseweb
	"81.171.0.0/19"    # NL - Leaseweb
	"37.48.78.87"      # NL - Leaseweb
	"62.210.0.0/16"    # fr - Scaleway hosts malware, dns blocklisted
	"163.172.0.0/16"   # fr - Scaleway hosts malware, dns blocklisted
	"192.119.160.0/20" # us - "madgenius.com" scam sender
	"155.94.191.0/24"  # us - "madgenius.com" scam sender
	"165.140.240.0/22" # us - alphavps scam sender
	"109.71.254.0/24"  # de - emeraldhost.de apple ID phishing scammer
	"41.61.0.0/17"     # hu/sa - grindhost - canadapost/intelcom phishing scammer; viagra
	"77.87.208.0/21"   # ru - bad spam
	"5.104.104.0/21"   # de male gummies
	# notable smtp connections without purpose
	"193.222.96.0/24" # fr contantmoulin, 4000 connections over several days
	# auth violators
	"111.0.0.0/10"   # cn - china mobile
	"27.115.0.0/17"  # cn - china unicom
	"80.244.11.0/24" # ir - iran posing as nl
	# spf and dmarc violators
	"191.180.0.0/14"  # br
	"103.31.179.0/24" # bd
	# # msedge.exe / exploit
	"212.102.40.0/23" # uk /dallas us
)

for ip in "${BADACTORS[@]}"; do
	case $ip in
	$DONTBLOCK)
		iptables -C INPUT -j ACCEPT -s "$ip" >/dev/null 2>&1 || iptables -I INPUT -s "$ip" -j ACCEPT
		continue
		;;
	*)
		# Adds an ip or /netblock to iptables drop list, if it isn't already in there
		if ! iptables -C INPUT -j DROP -s "$ip" >/dev/null 2>&1; then
			iptables -A INPUT -j DROP -s "$ip"
			logger "mox known bad actors DROP $ip"
			let COUNT++
		fi
		;;
	esac
done
logger "$SCRIPT finished, $COUNT DROP rules added"
